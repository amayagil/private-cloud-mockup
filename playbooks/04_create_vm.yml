---
- name: Create VM in private cloud
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: Validate inherited workflow data
      ansible.builtin.assert:
        that:
          - vm_name is defined
          - vm_profile is defined
          - vm_storage_gb is defined
          - vm_sla is defined
          - selected_profile is defined
        fail_msg: "Missing required variables from previous steps..."

    - name: Step 4.1 - Initiate VM creation
      ansible.builtin.debug:
        msg:
          - "Initiating private cloud API call to create VM '{{ vm_name }}'..."
          - "Using profile '{{ selected_profile }}'"
          - "CPU: {{ vm_profile.cpu }} vCPU"
          - "RAM: {{ vm_profile.ram_gb }} GB"
          - "Storage: {{ vm_storage_gb }} GB"
          - "SLA: {{ vm_sla | upper }}"

    - name: Step 4.2 - Simulate provisioning delay
      ansible.builtin.pause:
        seconds: 5
        prompt: "Provisioning VM '{{ vm_name }}'... Press [Enter] to simulate completion."

    - name: Step 4.3 - Show full VM configuration summary
      ansible.builtin.debug:
        msg:
          - "   FINAL VM CONFIGURATION SUMMARY"
          - "────────────────────────────────────"
          - "Name: {{ vm_name }}"
          - "Profile: {{ selected_profile }}"
          - "CPU: {{ vm_profile.cpu }} vCPU"
          - "RAM: {{ vm_profile.ram_gb }} GB"
          - "Storage: {{ vm_storage_gb }} GB"
          - "SLA Tier: {{ vm_sla | upper }}"
          - "Network IP: {{ vm_ip_address | default('N/A') }}"
          - "DNS Record: {{ vm_dns_record | default('N/A') }}"
          - "Security Policy: {{ vm_security | default('N/A') }}"
          - "────────────────────────────────────"
          - "Provisioning Status: SUCCESS!"

    - name: Record final workflow state
      ansible.builtin.set_stats:
        data:
          vm_creation_successful: true
          last_task: "{{ ansible_current_name | default('VM creation complete') }}"
