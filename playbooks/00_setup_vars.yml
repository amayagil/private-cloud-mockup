# playbooks/00_setup_vars.yml
---
- name: Vars settings
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    # Used when running manually, otherwise provided by survey
    vm_size: "{{ vm_size | default('small') }}"
    vm_sla: "{{ vm_sla | default(omit) }}"

  pre_tasks:
    - name: Load VM Config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vars/vm_config.yml"
        name: vm_config
      ignore_errors: yes

    - name: Load Capacity Profiles
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vars/capacity_profiles.yml"
        name: capacity_data
      ignore_errors: yes

  tasks:
    - name: Debug raw vm_size (from survey or default)
      ansible.builtin.debug:
        var: vm_size

    - name: Normalize vm_size to internal key (with debug)
      ansible.builtin.set_fact:
        _debug_vm_raw: "{{ vm_size }}"
        _debug_vm_lower: "{{ vm_size | string | lower | trim }}"
        normalized_vm_size: >-
          {% set v = (vm_size | string | lower | trim) %}
          {% if v is search('^small') or v is search('small') %}
          small
          {% elif v is search('^medium') or v is search('medium') %}
          medium
          {% elif v is search('^large') or v is search('large') %}
          large
          {% else %}
          {{ v | regex_replace('[^a-z0-9_]+', '') }}
          {% endif %}

    - name: Debug normalization details
      ansible.builtin.debug:
        msg:
          - "Raw vm_size: {{ _debug_vm_raw }}"
          - "Lowercased: {{ _debug_vm_lower }}"
          - "Normalized: {{ normalized_vm_size }}"

    - name: Apply normalized vm_size
      ansible.builtin.set_fact:
        vm_size: "{{ normalized_vm_size | trim }}"

    - name: Debug normalized vm_size
      ansible.builtin.debug:
        msg: "vm_size normalized to '{{ vm_size }}'"

    - name: Define defaults if files not found
      ansible.builtin.set_fact:
        # asegura que capacity_data tenga estructura base
        capacity_data: "{{ capacity_data | default({
          'capacity_profiles': {
            'small':  {'cpu': 2, 'ram_gb': 4,  'storage_gb': 10},
            'medium': {'cpu': 4, 'ram_gb': 8,  'storage_gb': 20},
            'large':  {'cpu': 8, 'ram_gb': 16, 'storage_gb': 30}}
         }) }}"
        # prioriza el valor de survey vm_size sobre vm_config y luego 'medium' igual con vm_sla
        selected_profile: "{{ vm_size | default(vm_config.selected_capacity_profile | default('medium')) }}"
        vm_name: "{{ vm_config.vm_name | default('default-vm') }}"
        effective_sla: "{{ vm_sla | default(vm_config.vm_sla | default('silver')) }}"

    - name: Validate selected profile
      ansible.builtin.assert:
        that:
          - selected_profile in capacity_data.capacity_profiles
        fail_msg: "Profile '{{ selected_profile }}' not found in capacity_profiles."
        success_msg: "Using capacity profile '{{ selected_profile }}'."

    - name: Validate SLA level
      ansible.builtin.assert:
        that:
          - effective_sla in ['bronze', 'silver', 'gold']
        fail_msg: "Invalid SLA '{{ effective_sla }}'. Allowed values: bronze, silver, gold."
        success_msg: "Using SLA level '{{ effective_sla }}'."

    - name: Set vm_profile based on selected profile
      ansible.builtin.set_fact:
        vm_profile: "{{ capacity_data.capacity_profiles[selected_profile] }}"

    - name: Confirm Profile Loaded
      ansible.builtin.debug:
        msg: >
          Capacity Profile '{{ selected_profile | upper }}' loaded:
          CPU={{ vm_profile.cpu }} cores,
          RAM={{ vm_profile.ram_gb }} GB,
          Disk={{ vm_profile.storage_gb }} GB,
          VM={{ vm_name }},
          SLA={{ effective_sla | upper }}.

    # Exporta variables al siguiente paso del Workflow
    - name: Save vm_profile for next workflow step
      ansible.builtin.set_stats:
        data:
          vm_profile: "{{ vm_profile }}"
          vm_name: "{{ vm_name }}"
          selected_profile: "{{ selected_profile }}"
          vm_sla: "{{ effective_sla }}"

    # Registra el nombre de la Ãºltima tarea ejecutada antes del fallo.
    - name: Track current task
      ansible.builtin.set_stats:
        data:
          last_task: "{{ ansible_current_name | default('unknown') }}"

