---
- name: MASTER WORKFLOW - Windows VM Private Cloud Provisioning
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - ../vars/vm_config.yml
    - ../vars/capacity_profiles.yml

  pre_tasks:
    - name: Set VM Profile Fact
      ansible.builtin.set_fact:
        vm_profile: "{{ capacity_profiles[vm_config.selected_capacity_profile] }}"

    - name: DEBUG - Confirm Profile Loaded
      ansible.builtin.debug:
        msg: "Provisioning pipeline initiated for VM '{{ vm_config.vm_name }}' using {{ vm_config.selected_capacity_profile | upper }} profile."

  tasks:
    - name: STAGE 1 - Storage Capacity Check
      ansible.builtin.include_tasks: 01_check_storage.yml

    - name: STAGE 2 - Compute (CPU/RAM) Capacity Check
      ansible.builtin.include_tasks: 02_check_compute.yml

    - name: STAGE 3 - Network Provisioning (IP, SG, DNS)
      ansible.builtin.include_tasks: 03_provision_network.yml

    - name: STAGE 4 - Final VM Creation Mock
      ansible.builtin.include_tasks: 04_create_vm.yml