# playbooks/01_check_storage.yml
---
- name: Storage capacity check
  hosts: localhost
  connection: local
  gather_facts: no

  pre_tasks:
    - name: Load VM Config
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vars/vm_config.yml"
        name: vm_config
      ignore_errors: yes

    - name: Load Capacity Profiles
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../vars/capacity_profiles.yml"
        name: capacity_data
      ignore_errors: yes

  tasks:
    - name: Define effective storage capacity (survey > vm_config > profile default)
      ansible.builtin.set_fact:
        effective_storage_gb: >-
          {{ vm_storage_gb
             | default(vm_config.vm_storage_gb
             | default(vm_profile.storage_gb
             | default(50))) }}

    - name: Show received workflow variables
      ansible.builtin.debug:
        msg:
          - "Received VM name: {{ vm_name | default('undefined') }}"
          - "Selected profile: {{ selected_profile | default('undefined') }}"
          - "CPU: {{ vm_profile.cpu | default('N/A') }}"
          - "RAM: {{ vm_profile.ram_gb | default('N/A') }} GB"
          - "Storage: {{ effective_storage_gb }} GB (final effective value)"

    - name: Validate that vm_profile was passed correctly
      ansible.builtin.assert:
        that:
          - vm_profile is defined
          - effective_storage_gb | int > 0
        fail_msg: "ERROR: vm_profile or effective_storage_gb missing or invalid."

    - name: Simulate querying storage cluster
      ansible.builtin.debug:
        msg: >
          Querying storage cluster to ensure {{ effective_storage_gb }} GB
          is available for VM '{{ vm_name }}'.

    - name: Simulate storage API call
      ansible.builtin.pause:
        seconds: 3
        prompt: "Storage check API response received... Space RESERVED. Press [Enter] to continue."

    - name: Ensure effective_sla is defined
      ansible.builtin.set_fact:
        effective_sla: "{{ effective_sla | default(vm_sla | default(vm_config.vm_sla | default('silver'))) }}"

    - name: Save result for next workflow step
      ansible.builtin.set_stats:
        data:
          storage_check_passed: true
          vm_profile: "{{ vm_profile }}"
          vm_name: "{{ vm_name }}"
          vm_storage_gb: "{{ effective_storage_gb }}"
          selected_profile: "{{ selected_profile }}"
          vm_sla: "{{ effective_sla }}"
          last_task: "{{ ansible_current_name | default('Storage capacity check complete') }}"